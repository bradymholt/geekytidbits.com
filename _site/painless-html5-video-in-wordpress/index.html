<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Painless HTML5 Video in WordPress | Geeky Tidbits</title>
    <meta name="description" content="Preface: this post contains a specific implementation to a common problem.  Although my solution below involves iPhone videos and integration with a WordPres...">
    <link href='//fonts.googleapis.com/css?family=IBM+Plex+Serif' rel='stylesheet' type='text/css'>
    <style>body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0;-webkit-font-smoothing:antialiased}body{font-family:"IBM Plex Serif",serif;font-size:1.2em;line-height:1.5;font-weight:300;color:#444;background-color:#f7f7f7;-webkit-text-size-adjust:100%}h1,h2,h3,h4,h5,h6,p,blockquote,pre,ul,ol,dl,figure{margin-bottom:15px}img{max-width:100%;vertical-align:middle}figure>img{display:block}ul,ol{margin-left:30px}ul.condensed{columns:2;-webkit-columns:2;-moz-columns:2;list-style-type:disc;list-style-position:inside}li>ul,li>ol{margin-bottom:0}h2,h3,h4,h5,h6{font-weight:300}h1{font-weight:600;font-size:42px;line-height:1;padding-top:35px}@media screen and (max-width: 600px){h1{font-size:36px}}a{color:#126ca6;text-decoration:none}a:visited{color:#126ca6}a:hover{color:#178ad4}blockquote{color:#828282;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre{font-size:1em;padding:8px 12px;overflow-x:scroll}code{background-color:#f8f8f8}time{margin-right:10px}.wrapper{position:relative;width:800px;margin-right:auto;margin-left:auto;padding-right:30px;padding-left:30px;border-left:solid 225px transparent}@media screen and (max-width: 1085px){.wrapper{width:auto;border-left:0}}.page-content .wrapper{border-left:solid 225px #f7f7f7;background-color:#fff;padding-bottom:50px}@media screen and (max-width: 1085px){.page-content .wrapper{width:auto}}@media screen and (max-width: 600px){.page-content .wrapper{border-left:0}}.wrapper:after{content:"";display:table;clear:both}.icon>svg{display:inline-block;width:16px;height:16px;vertical-align:middle}.icon>svg path{fill:#828282}.site-header{border-bottom:3px solid #f68905;background-color:#237ab2;padding-bottom:10px;color:white;position:relative}.site-header img{margin-top:10px}.site-title{font-size:26px;line-height:56px;letter-spacing:-1px;margin-bottom:0}.site-description{font-size:17px}.site-footer{padding:10px 0 30px;color:#828282;font-style:italic}.page-content img{margin:20px}.post-header{margin-bottom:20px}.post .post-meta{display:inline-block;border:1px solid rgba(0,0,0,0.05);border-left:none;border-right:none;padding:8px 0 8px 30px;margin-top:10px;margin-left:-30px}.post-content h2{font-size:32px}@media screen and (max-width: 600px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width: 600px){.post-content h3{font-size:22px}}.post-content h4{font-size:20px}@media screen and (max-width: 600px){.post-content h4{font-size:18px}}.post-list{margin-left:0;list-style:none}.post-list>li{margin-bottom:30px}.post-list img{max-height:100px}.post-meta{font-size:1em;color:#828282}.post-link{display:block;font-size:24px}.sidebar{font-size:16px;position:absolute;left:-195px;width:195px}.sidebar ul{margin-left:0px;list-style:none}.sidebar ul li{transition:all 0.2s ease-in-out}.sidebar ul li:hover{transform:scale(1.1)}.sidebar ul li a{text-decoration:none}.sidebar svg.social{width:25px;height:25px;margin:5px;vertical-align:middle}.sidebar img.head-shot{width:145px;height:145px;border-radius:75px;margin:10px 0}.sidebar h3{margin-bottom:0;font-weight:bold}.sidebar h4{font-style:italic;font-size:15px}.sidebar .site-nav{font-size:larger;line-height:30px}@media screen and (max-width: 600px){.sidebar{position:static;width:100%;text-align:center;display:none}.sidebar .head-shot{display:inline-block}.sidebar ul.social-links{width:150px;text-align:left;margin:0 auto;padding-left:20px}}@media screen and (max-width: 600px){body.home .sidebar{display:block}ul.condensed{columns:1;-webkit-columns:1;-moz-columns:1}}.pull-right{float:right !important}.pull-left{float:left !important}.block{display:block}.no-margin{margin:0px !important}table{table-layout:fixed;width:100%;border-collapse:collapse;margin:10px 0 20px 0}table th{text-align:left}table th,table td{padding:5px;border:1px solid lightgray}.highlight .hll{background-color:#ffffcc}.highlight{background:#f8f8f8}.highlight .c{color:#408080;font-style:italic}.highlight .err{border:1px solid #ff0000}.highlight .k{color:#008000;font-weight:bold}.highlight .o{color:#666666}.highlight .ch{color:#408080;font-style:italic}.highlight .cm{color:#408080;font-style:italic}.highlight .cp{color:#bc7a00}.highlight .cpf{color:#408080;font-style:italic}.highlight .c1{color:#408080;font-style:italic}.highlight .cs{color:#408080;font-style:italic}.highlight .gd{color:#a00000}.highlight .ge{font-style:italic}.highlight .gr{color:#ff0000}.highlight .gh{color:#000080;font-weight:bold}.highlight .gi{color:#00a000}.highlight .go{color:#888888}.highlight .gp{color:#000080;font-weight:bold}.highlight .gs{font-weight:bold}.highlight .gu{color:#800080;font-weight:bold}.highlight .gt{color:#0044dd}.highlight .kc{color:#008000;font-weight:bold}.highlight .kd{color:#008000;font-weight:bold}.highlight .kn{color:#008000;font-weight:bold}.highlight .kp{color:#008000}.highlight .kr{color:#008000;font-weight:bold}.highlight .kt{color:#b00040}.highlight .m{color:#666666}.highlight .s{color:#ba2121}.highlight .na{color:#7d9029}.highlight .nb{color:#008000}.highlight .nc{color:#0000ff;font-weight:bold}.highlight .no{color:#880000}.highlight .nd{color:#aa22ff}.highlight .ni{color:#999999;font-weight:bold}.highlight .ne{color:#d2413a;font-weight:bold}.highlight .nf{color:#0000ff}.highlight .nl{color:#a0a000}.highlight .nn{color:#0000ff;font-weight:bold}.highlight .nt{color:#008000;font-weight:bold}.highlight .nv{color:#19177c}.highlight .ow{color:#aa22ff;font-weight:bold}.highlight .w{color:#bbbbbb}.highlight .mb{color:#666666}.highlight .mf{color:#666666}.highlight .mh{color:#666666}.highlight .mi{color:#666666}.highlight .mo{color:#666666}.highlight .sa{color:#ba2121}.highlight .sb{color:#ba2121}.highlight .sc{color:#ba2121}.highlight .dl{color:#ba2121}.highlight .sd{color:#ba2121;font-style:italic}.highlight .s2{color:#ba2121}.highlight .se{color:#bb6622;font-weight:bold}.highlight .sh{color:#ba2121}.highlight .si{color:#bb6688;font-weight:bold}.highlight .sx{color:#008000}.highlight .sr{color:#bb6688}.highlight .s1{color:#ba2121}.highlight .ss{color:#19177c}.highlight .bp{color:#008000}.highlight .fm{color:#0000ff}.highlight .vc{color:#19177c}.highlight .vg{color:#19177c}.highlight .vi{color:#19177c}.highlight .vm{color:#19177c}.highlight .il{color:#666666}
</style>
    <link rel="canonical" href="https://www.geekytidbits.com/painless-html5-video-in-wordpress/">
    <link rel="alternate" type="application/rss+xml" title="Geeky Tidbits" href="https://www.geekytidbits.com/feed/" />
    <link rel="amphtml" href="https://www.geekytidbits.com/amp/painless-html5-video-in-wordpress.html">
</head>

<body>
    <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" />
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    <div class="page-content">
        <div class="wrapper">
            <div class="sidebar">
    <img class="head-shot" alt="Brady Holt" width="145px" height="145px" src="//s.gravatar.com/avatar/ae474dd4a074fd22e897c4c54770c05a?s=290">
    <h3>Brady Holt</h3>
    <h4>Geek, developer at <a target="_blank" href="http://www.youneedabudget.com/">YNAB</a>, voider of warranties</h4>
    <nav class="site-nav">
        <ul> 
            <li>
                <a class="page-link" href="/about-me/">About Me</a>
            </li>
            <li>
                <a class="page-link" href="/projects/">Projects</a>
            </li>
            <li>
                <a class="page-link" href="/posts/">Posts</a>
            </li>
        </ul>
    </nav>
    <p>Connect with me!</p>
    <ul class="social-links">
        <li>
            <a href="http://github.com/bradymholt">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M16 0c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16-7.163-16-16-16zM25.502 25.502c-1.235 1.235-2.672 2.204-4.272 2.881-0.406 0.172-0.819 0.323-1.238 0.453v-2.398c0-1.26-0.432-2.188-1.297-2.781 0.542-0.052 1.039-0.125 1.492-0.219s0.932-0.229 1.438-0.406 0.958-0.388 1.359-0.633 0.786-0.563 1.156-0.953 0.68-0.833 0.93-1.328 0.448-1.089 0.594-1.781 0.219-1.456 0.219-2.289c0-1.615-0.526-2.99-1.578-4.125 0.479-1.25 0.427-2.609-0.156-4.078l-0.391-0.047c-0.271-0.031-0.758 0.083-1.461 0.344s-1.492 0.688-2.367 1.281c-1.24-0.344-2.526-0.516-3.859-0.516-1.344 0-2.625 0.172-3.844 0.516-0.552-0.375-1.075-0.685-1.57-0.93s-0.891-0.411-1.188-0.5-0.573-0.143-0.828-0.164-0.419-0.026-0.492-0.016-0.125 0.021-0.156 0.031c-0.583 1.479-0.635 2.839-0.156 4.078-1.052 1.135-1.578 2.51-1.578 4.125 0 0.833 0.073 1.596 0.219 2.289s0.344 1.286 0.594 1.781 0.56 0.938 0.93 1.328 0.755 0.708 1.156 0.953 0.854 0.456 1.359 0.633 0.984 0.313 1.438 0.406 0.95 0.167 1.492 0.219c-0.854 0.583-1.281 1.51-1.281 2.781v2.445c-0.472-0.14-0.937-0.306-1.394-0.5-1.6-0.677-3.037-1.646-4.272-2.881s-2.204-2.672-2.881-4.272c-0.7-1.655-1.055-3.414-1.055-5.23s0.355-3.575 1.055-5.23c0.677-1.6 1.646-3.037 2.881-4.272s2.672-2.204 4.272-2.881c1.655-0.7 3.415-1.055 5.23-1.055s3.575 0.355 5.23 1.055c1.6 0.677 3.037 1.646 4.272 2.881s2.204 2.672 2.881 4.272c0.7 1.655 1.055 3.415 1.055 5.23s-0.355 3.575-1.055 5.23c-0.677 1.6-1.646 3.037-2.881 4.272z"></path>
                </svg>GitHub
            </a>
        </li>
        <li>
            <a href="http://stackoverflow.com/users/626911/brady?tab=profile">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M32 20v12h-32v-12h4v8h24v-8zM6 22h20v4h-20zM6.473 17.671l0.866-3.905 19.526 4.328-0.866 3.905zM8.739 9.642l1.69-3.625 18.126 8.452-1.69 3.625zM30.991 11.296l-2.435 3.173-15.867-12.175 1.761-2.294h1.82z"></path>
                </svg>Stack Overflow
            </a>
        </li>
        <li>
            <a href="http://twitter.com/bradymholt">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M32 6.076c-1.177 0.522-2.443 0.875-3.771 1.034 1.355-0.813 2.396-2.099 2.887-3.632-1.269 0.752-2.674 1.299-4.169 1.593-1.198-1.276-2.904-2.073-4.792-2.073-3.626 0-6.565 2.939-6.565 6.565 0 0.515 0.058 1.016 0.17 1.496-5.456-0.274-10.294-2.888-13.532-6.86-0.565 0.97-0.889 2.097-0.889 3.301 0 2.278 1.159 4.287 2.921 5.465-1.076-0.034-2.088-0.329-2.974-0.821-0.001 0.027-0.001 0.055-0.001 0.083 0 3.181 2.263 5.834 5.266 6.437-0.551 0.15-1.131 0.23-1.73 0.23-0.423 0-0.834-0.041-1.235-0.118 0.835 2.608 3.26 4.506 6.133 4.559-2.247 1.761-5.078 2.81-8.154 2.81-0.53 0-1.052-0.031-1.566-0.092 2.905 1.863 6.356 2.95 10.064 2.95 12.076 0 18.679-10.004 18.679-18.68 0-0.285-0.006-0.568-0.019-0.849 1.283-0.926 2.396-2.082 3.276-3.398z"></path>
                </svg>Twitter
            </a>
        </li>
        <li>
            <a href="http://www.linkedin.com/in/bradymholt">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M12 12h5.535v2.837h0.079c0.77-1.381 2.655-2.837 5.464-2.837 5.842 0 6.922 3.637 6.922 8.367v9.633h-5.769v-8.54c0-2.037-0.042-4.657-3.001-4.657-3.005 0-3.463 2.218-3.463 4.509v8.688h-5.767v-18z"></path>
                    <path fill="#444444" d="M2 12h6v18h-6v-18z"></path>
                    <path fill="#444444" d="M8 7c0 1.657-1.343 3-3 3s-3-1.343-3-3c0-1.657 1.343-3 3-3s3 1.343 3 3z"></path>
                </svg>LinkedIn
            </a>
        </li>
        <li>
            <a href="/feed/">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M4.259 23.467c-2.35 0-4.259 1.917-4.259 4.252 0 2.349 1.909 4.244 4.259 4.244 2.358 0 4.265-1.895 4.265-4.244-0-2.336-1.907-4.252-4.265-4.252zM0.005 10.873v6.133c3.993 0 7.749 1.562 10.577 4.391 2.825 2.822 4.384 6.595 4.384 10.603h6.16c-0-11.651-9.478-21.127-21.121-21.127zM0.012 0v6.136c14.243 0 25.836 11.604 25.836 25.864h6.152c0-17.64-14.352-32-31.988-32z"></path>
                </svg>Feed
            </a>
        </li>
    </ul>
</div>
 <div class="post">
    <header class="post-header">
        <h1 class="post-title">Painless HTML5 Video in WordPress</h1>
        <p class="post-meta">Jun 13, 2011</p>
    </header>
    <article class="post-content">
        <p><em>Preface: this post contains a specific implementation to a common problem.  Although my solution below involves iPhone videos and integration with a WordPress blog, the information can be used to build a solution to suit your own needs.</em></p>

<h3 id="in-short">In Short</h3>

<p>In this post, I explain how to setup and configure a combination of software and tools on a Linux server running a WordPress blog that enables <strong>painless</strong> uploading and sharing of videos hosted directly from your own server, rather than a third party service like YouTube.  Once everything is setup, adding a video to a blog post is as easy as uploading it through WordPress and using a shortcode such as [video src=”/media/myvideo”] to stream your video using HTM5 and Flash as a fallback option.  The initial setup for this solution is a bit of work but the payoff is huge!</p>

<p>Watch the video below to see a demo of just how painless it is!</p>

<video width="780" height="380" autoplay="" poster="/media/painless_poster.png">
  <source src="/media/painless_html5_video.m4v" type="video/mp4" />
  Sorry, your browser doesn't support embedded videos,
  but don't worry, you can <a href="/media/painless_html5_video.m4v">download it</a>
  and watch it with your favorite video player!
</video>

<h3 id="assumptions">Assumptions</h3>

<p>You need a Linux web server with administrative privileges and a WordPress (self-hosted) blog software installation to complete the steps below.  <em>If you don’t use Linux or WordPress see the preface at the top of this post.</em></p>

<h3 id="background">Background</h3>

<p>My wife and I recently had our first child. With that comes the insatiable desire to share video after video of our adorable little daughter!</p>

<p>The way I’ve usually shared videos on the web has been to upload them to <a href="http://www.YouTube.com" target="_blank">YouTube</a> or <a href="http://www.vimeo.com" target="_blank">Vimeo</a> and embed them on my own site. As the quantity and frequency of my video posting was about to skyrocket I stepped back and thought, “Why do I have to post my videos on a 3rd party site just to share it on the web”?  It just seems like in principle I shouldn’t have to.  Also,  it can be kind of tedious to login to another site, upload a video, wait for conversion, get the embed code, etc.  Yes, I could use a Flash player and host on my own but Flash doesn’t work everywhere (i.e. iPhone / iPad) and there are other heavy issues to deal with such as video format (container / codec), bitrate, etc.  HTML5 video seems like a good option but because of the ongoing <a href="http://arstechnica.com/open-source/news/2009/07/decoding-the-html-5-video-codec-debate.ars" target="_blank">codec debate</a> you still have to do some painful work to get your video in the right formats to support all the major browsers and also allow for a fallback option when HTML5 video isn’t available (I’m glaring at you, Internet Explorer 7 &amp; 8).</p>

<p><strong>Let’s be honest</strong>.  Working with video on the web isn’t exactly easy.</p>

<h3 id="wish-list">Wish List</h3>

<p>I wanted the following:</p>

<ul>
  <li>Support videos taken from my <strong>iPhone</strong>, which are MOV / QuickTime format.</li>
  <li>Integration with <a href="http://wordpress.org/" target="_blank">WordPress</a> blogging software (self-hosted version).</li>
  <li>Host and serve the videos from my <strong>own server</strong> without delegating to a 3rd party service like YouTube or Vimeo.</li>
  <li>Support playback on most all browsers / platforms, including <strong>platforms without Flash support</strong>.</li>
  <li>Take advantage of <strong>HTML5</strong> video.  It’s the future of the web so now is a good time to learn it and use it.</li>
  <li>Be able to <strong>quickly</strong> and <strong>easily</strong> upload and share videos.  I didn’t want to have to run a video conversion program and convert to 4 different formats and write a ton of HTML markup just to share.  If it isn’t easy, I probably won’t use it long-term.</li>
</ul>

<h3 id="solution">Solution</h3>

<h4 id="high-level-approach">High-level approach</h4>

<p>I have a file watching service running on my Linux web server.  When it detects a new file in a specified directory it runs a script.  This script checks for a video file type and if found, converts it to other HTML5 compatible formats using some command line video conversion utilities.  Then, I have a WordPress plugin installed that dynamically checks the filesystem for available video formats and generates HTML5 markup with Flash fallback accordingly.</p>

<h4 id="setup-steps">Setup Steps</h4>

<ol>
  <li>
    <p>Install the following on your Linux box:</p>

    <p><strong><a href="http://inotify.aiken.cz/?section=incron&amp;page=about&amp;lang=en" target="_blank">incron</a></strong>- This is a daemon that is similar to cron except it is triggered by filesystem events rather than time intervals.
<strong><a href="http://www.ffmpeg.org/" target="_blank">ffmpeg</a></strong>-_The_ swiss-army knife for audio / video conversion.  This is one powerful program!  Note: you will likely need to compile ffmpeg yourself because most package repositories (i.e. yum install ffmpeg) contain a version of ffmpeg not compiled with options you will need.  I used the <a href="http://ubuntuforums.org/showthread.php?t=786095" target="_blank">HOWTO: Install and use the latest FFmpeg and x264</a> guide to install with the following ffmpeg configure / make statements: &lt;pre class="brush: text;"&gt;./configure –enable-gpl –enable-version3 –enable-nonfree –enable-postproc –enable-libfaac –enable-libmp3lame –enable-libtheora –enable-libvorbis –enable-libx264 –enable-libxvid –enable-libvpx –enable-pthreads; make; make install&lt;/pre&gt;</p>

    <p><strong>qt-faststart</strong>- This is a tool that reorders MP4 meta-data for better web streaming.  qt-faststart is included as part of the ffmpeg source but you need to build it separately.  The ffmpeg HOWTO guide above includes instructions on building and installing qt-faststart so be sure to follow those.
<strong><a href="http://v2v.cc/~j/ffmpeg2theora/" target="_blank">ffmpeg2theora</a></strong>- A simple converter to create Ogg Theora files.</p>

    <ul>
      <li><a href="http://matroska.org/downloads/mkclean.html" target="_blank"><strong>mkclean</strong></a> – A command line tool to clean and optimize WebM video files for better web streaming.</li>
    </ul>
  </li>
  <li>Install and activate the <a href="http://wordpress.org/extend/plugins/degradable-html5-audio-and-video/" target="_blank">Degradable HTML5 audio and video</a> WordPress plugin.  This plugin is responsible for generating the HTML markup for us.
    <ol>
      <li>Login to your WordPress admin console and click “Add New” under the Plugins area.</li>
      <li>Search for “Degradable HTML5 audio and video” and click to Install and then Activate when prompted.</li>
    </ol>
  </li>
  <li>
    <p>Create a bash script to handle the video conversions:</p>

    <ul>
      <li>Run <strong>nano /usr/local/bin/convert_video_html5</strong> from your Linux shell to create the bash script.</li>
      <li>Add the following contents to the script:</li>
    </ul>
  </li>
</ol>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nv">ORIG_FILENAME</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="p">##*/</span><span class="k">}</span>
<span class="nv">ORIG_EXTENSION</span><span class="o">=</span><span class="k">${</span><span class="nv">ORIG_FILENAME</span><span class="p">##*.</span><span class="k">}</span>
<span class="nv">ORIG_EXTENSION</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$ORIG_EXTENSION</span> | <span class="nb">tr</span> <span class="s2">"[:upper:]"</span> <span class="s2">"[:lower:]"</span><span class="k">)</span>
<span class="nv">ORIG_BASE</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="p">%</span><span class="nv">$ORIG_EXTENSION</span><span class="k">}</span>
<span class="nv">JPG_FILENAME</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">MP4_FILENAME</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">MP4_FFMPEG_CONVERT_OPTIONS</span><span class="o">=</span><span class="s2">" -y -f mp4 -acodec libfaac -vcodec libx264 -b 700k -vf scale=480:-1"</span>
<span class="nv">OGV_FILENAME</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">WEBM_FILENAME</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">WEBM_FFMPEG_CONVERT_OPTIONS</span><span class="o">=</span><span class="s2">" -y -f webm -b 700k"</span>
<span class="nv">TEMP_FILE_SUFFIX</span><span class="o">=</span><span class="s2">"_tmp"</span>
<span class="nv">PROCESS_PRIORITY</span><span class="o">=</span><span class="s2">"15"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$ORIG_EXTENSION</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"mov"</span> <span class="nt">-o</span> <span class="s2">"</span><span class="nv">$ORIG_EXTENSION</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"mp4"</span> <span class="nt">-o</span> <span class="s2">"</span><span class="nv">$ORIG_EXTENSION</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"avi"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
</span><span class="nv">JPG_FILENAME</span><span class="o">=</span><span class="nv">$ORIG_BASE</span><span class="s2">"jpg"</span>
<span class="nv">MP4_FILENAME</span><span class="o">=</span><span class="nv">$ORIG_BASE</span><span class="s2">"m4v"</span>
<span class="nv">OGV_FILENAME</span><span class="o">=</span><span class="nv">$ORIG_BASE</span><span class="s2">"ogv"</span>
<span class="nv">WEBM_FILENAME</span><span class="o">=</span><span class="nv">$ORIG_BASE</span><span class="s2">"webm"</span>

<span class="c">#pause to wait for file to finish writing</span>
<span class="nb">sleep </span>3

<span class="c">#generate poster thumbnnail</span>
<span class="nb">nice</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$PROCESS_PRIORITY</span><span class="s2">"</span> /usr/local/bin/ffmpeg <span class="nt">-y</span> <span class="nt">-i</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="nt">-f</span> image2 <span class="nt">-an</span> <span class="nt">-ss</span> 00:00:04 <span class="nt">-vframes</span> 1 <span class="s2">"</span><span class="nv">$JPG_FILENAME</span><span class="s2">"</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$ORIG_EXTENSION</span> <span class="o">==</span> <span class="s1">'mp4'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c">#no conversion needed for m4v format, just copy it</span>
  <span class="nb">cp</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$MP4_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$ORIG_EXTENSION</span> <span class="o">==</span> <span class="s1">'mov'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c">#simple container conversion needed, copy video / audio content without re-encoding</span>
  <span class="nb">nice</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$PROCESS_PRIORITY</span><span class="s2">"</span> /usr/local/bin/ffmpeg <span class="nt">-y</span> <span class="nt">-i</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="nt">-f</span> mp4 <span class="nt">-acodec</span> copy <span class="nt">-vcodec</span> copy <span class="s2">"</span><span class="nv">$MP4_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span>
<span class="k">else</span>
  <span class="c">#re-encoding is needed</span>
  <span class="nb">nice</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$PROCESS_PRIORITY</span><span class="s2">"</span> /usr/local/bin/ffmpeg <span class="nt">-i</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">${</span><span class="nv">MP4_FFMPEG_CONVERT_OPTIONS</span><span class="k">}</span> <span class="s2">"</span><span class="nv">$MP4_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c">#move mp4 metadata to front of file for streaming</span>
<span class="nb">nice</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$PROCESS_PRIORITY</span><span class="s2">"</span> /usr/local/bin/qt-faststart <span class="s2">"</span><span class="nv">$MP4_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$MP4_FILENAME</span><span class="s2">"</span>
<span class="nb">rm</span> <span class="s2">"</span><span class="nv">$MP4_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span>

<span class="c">#generate Ogg Theora format</span>
<span class="nb">nice</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$PROCESS_PRIORITY</span><span class="s2">"</span> /usr/local/bin/ffmpeg2theora <span class="s2">"</span><span class="nv">$MP4_FILENAME</span><span class="s2">"</span> <span class="nt">-o</span> <span class="s2">"</span><span class="nv">$OGV_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span>
<span class="nb">mv</span> <span class="s2">"</span><span class="nv">$OGV_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$OGV_FILENAME</span><span class="s2">"</span>

<span class="c">#generate WEBM format</span>
<span class="nb">nice</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$PROCESS_PRIORITY</span><span class="s2">"</span> /usr/local/bin/ffmpeg <span class="nt">-i</span> <span class="s2">"</span><span class="nv">$MP4_FILENAME</span><span class="s2">"</span> <span class="k">${</span><span class="nv">WEBM_FFMPEG_CONVERT_OPTIONS</span><span class="k">}</span> <span class="s2">"</span><span class="nv">$WEBM_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span>
<span class="nb">nice</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$PROCESS_PRIORITY</span><span class="s2">"</span> /usr/local/bin/mkclean <span class="nt">--optimize</span> <span class="nt">--remux</span> <span class="s2">"</span><span class="nv">$WEBM_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$WEBM_FILENAME</span><span class="s2">"</span>
<span class="nb">rm</span> <span class="s2">"</span><span class="nv">$WEBM_FILENAME$TEMP_FILE_SUFFIX</span><span class="s2">"</span>
<span class="k">fi</span>
</code></pre></div></div>

<ul>
  <li>Run <strong>chmod+x /usr/local/bin/convert_video_html5</strong></li>
</ul>

<ol>
  <li>Setup <strong>incron</strong>. 1. Start incron by running <strong>service incrond start</strong>.  This command may vary depending on the Linux distribution you are using. 2. Edit the incron action table table by runing <strong>incrontab -e</strong>and adding the following line (entry) to the table:</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/var/www/html/wordpress/wp-content/uploads IN_CLOSE_WRITE,IN_MOVED_TO,IN_NO_LOOP /usr/local/bin/convert_video_html5 $@/$#
</code></pre></div></div>

<p>You should change <em>/var/www/html/wordpress/wp-content/uploads</em> above to be the wp-content/uploads folder location of your own WordPress installation.&lt;/li&gt;</p>

<ul>
  <li>
    <p>The action entry above tells incron to execute /usr/local/bin/convert_video_html5 when a file is either written to (IN_CLOSE_WRITE) or moved (IN_MOVED_TO) into the /var/www/html/wordpress/wp-content/uploads folder.  $@/$# tells incron to pass in the full path of the created/moved file to our conversion script.&lt;/ol&gt; &lt;/li&gt;</p>
  </li>
  <li>
    <p>Configure <strong>web server</strong></p>

    <ol>
      <li>Locate your web server config file.  I use Apache and the location of the file is /etc/httpd/conf/httpd.conf</li>
      <li>Add mime-type definitions for (at least) the following extensions: .ogv, .m4v, .mp4, .webm</li>
      <li>My Apache config has the following:
        <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AddType video/ogg .ogv .ogg
AddType video/mp4.mp4 .m4v
AddType video/webm .webm
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
</ul>

<h4 id="usage">Usage</h4>

<p>Now, with everything setup it is easy to upload a video and embed it in a WordPress blog post.  All I need to do is use the [video] shortcode with the following syntax.  Assuming I uploaded a video name myvideo.mov, you would use:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[video src="/media/myvideo"]
</code></pre></div></div>

<p>Notice the omission of the mov file extension above.  This is because the WordPress plugin we installed (“Degradable HTML5 audio and video”)  auto detect the videos present of the file system and generates the markup accordingly.  Our bash script (convert_video_html5) does all the video conversion behind the scenes and drops newly converted files in the same directory and the WordPress plugin finds them to use them.  If some of the conversions are still in process, the plugin will only use those currently available.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Phew.  That was a lot of work right?  But the payoff is huge!  It took quite a bit of time (and frustration) to come up with this solution but I am extremely happy with the outcome.  Now, I can take a quick video, upload it to WordPress and have it streaming HTML5 video cross platform/browser (with Flash fallback support) within seconds. <strong><em>Painless</em></strong>.</p>

<h3 id="enhancement">Enhancement</h3>

<p>This is my laundry list of things to work on in the future to make this solution even better:</p>

<ul>
  <li>Support more than just iPhone (MOV/QuickTime) and AVI video file formats.  This shouldn’t be hard since ffmpeg can work with tons of codecs and container formats.  A tweak to the convert_video_html5 script should enable this.</li>
  <li>Possibly add a trigger to the wp_posts WordPress MySql table so that default file upload syntax will automatically be changed to the shortcode syntax.  When you upload a video in WordPress, it adds an anchor link pointing to the new file (i.e. &lt;a href=”/wp-content/uploads/video.mov”&gt;Your Video&lt;/a&gt;).  With a trigger I would not have to modify this markup to the [video src…] format and it would truly be a “hands-off” approach.  I generally despise database triggers (except for audit purposes) and this seems very hackish to me so I doubt I will ever do this but it is at least a thought.  Perhaps there is a more elegant way to accomplish this.</li>
</ul>

    </article>
    <div id="disqus_thread"></div>
    
    <script type="text/javascript">
        
        var disqus_identifier = '368 http://www.geekytidbits.com/?p=368';
        
        var disqus_container_id = 'disqus_thread';
        var disqus_shortname = 'geekytidbits';
        var disqus_url = 'https://www.geekytidbits.com/painless-html5-video-in-wordpress/';
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the
        <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
    </noscript>
    
</div>
        </div>
    </div>
    <div class="wrapper">
        <footer class="site-footer">
    &copy; 2019 Brady Holt
</footer>

    </div>
    <script>
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-19416043-2', 'auto');
        ga('send', 'pageview');
    </script>
    </body>
</html>
